<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ATRIOS ‚Äî Leadership Talent Network</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,500;1,400;1,500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --orange: #E55934;
  --orange-deep: #D9594C;
  --olive: #C3BF6D;
  --olive-soft: rgba(195,191,109,0.15);
  --ink: #141414;
  --ink-soft: #2a2a2a;
  --white: #ffffff;
  --bg: #fafafa;
  --surface: #ffffff;
  --slate: #6b7280;
  --slate-light: #9ca3af;
  --border: #ebebeb;
  --border-strong: #d4d4d4;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.07);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.09);
  --shadow-lg: 0 12px 40px rgba(0,0,0,0.12);
  --radius: 16px;
  --radius-sm: 10px;
}

body {
  background: var(--bg);
  color: var(--ink);
  font-family: 'Sora', sans-serif;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  -webkit-font-smoothing: antialiased;
}

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.progress-bar {
  height: 3px;
  background: var(--border);
  position: fixed; top: 0; left: 0; right: 0; z-index: 400;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--orange), var(--olive));
  transition: width 0.7s cubic-bezier(.4,0,.2,1);
  border-radius: 0 3px 3px 0;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  background: var(--ink);
  padding: 0 28px;
  height: 62px;
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 200;
  box-shadow: 0 2px 12px rgba(0,0,0,0.18);
}

.header-left { display: flex; align-items: center; gap: 13px; }

/* Logo mark ‚Äî triangle with arrow */
.logo-mark {
  width: 36px; height: 36px;
  flex-shrink: 0;
}

.header-brand { display: flex; flex-direction: column; }
.brand-name {
  font-size: 15px; font-weight: 700;
  color: var(--white);
  letter-spacing: 0.12em;
  text-transform: uppercase;
  line-height: 1;
}
.brand-name span { color: var(--orange); }
.brand-sub {
  font-size: 10px; font-weight: 400;
  color: rgba(255,255,255,0.45);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-top: 3px;
}

.header-right {
  display: flex; align-items: center; gap: 8px;
  font-size: 11px; font-weight: 500;
  color: rgba(255,255,255,0.5);
  letter-spacing: 0.06em; text-transform: uppercase;
}
.online-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: #4ade80;
  box-shadow: 0 0 0 0 rgba(74,222,128,0.4);
  animation: livePulse 2s infinite;
}
@keyframes livePulse {
  0% { box-shadow: 0 0 0 0 rgba(74,222,128,0.5); }
  70% { box-shadow: 0 0 0 7px rgba(74,222,128,0); }
  100% { box-shadow: 0 0 0 0 rgba(74,222,128,0); }
}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
main {
  flex: 1; display: flex; flex-direction: column;
  max-width: 700px; width: 100%;
  margin: 0 auto; padding: 0 18px;
}

.chat-window {
  flex: 1; padding: 32px 0 16px;
  display: flex; flex-direction: column;
}

/* ‚îÄ‚îÄ DATE CHIP ‚îÄ‚îÄ */
.date-chip {
  display: flex; align-items: center; gap: 12px;
  font-size: 10.5px; font-weight: 500;
  color: var(--slate-light);
  letter-spacing: 0.1em; text-transform: uppercase;
  margin-bottom: 28px;
}
.date-chip::before, .date-chip::after {
  content: ''; flex: 1; height: 1px;
  background: var(--border);
}

/* ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ */
.msg {
  display: flex; gap: 11px;
  margin-bottom: 14px;
  animation: msgIn 0.32s cubic-bezier(.4,0,.2,1) both;
}
@keyframes msgIn {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}
.msg.user { flex-direction: row-reverse; }

/* Avatar */
.avatar {
  width: 34px; height: 34px; border-radius: 50%;
  flex-shrink: 0; margin-top: 2px;
  display: flex; align-items: center; justify-content: center;
}
.avatar.bot {
  background: var(--orange);
  box-shadow: 0 2px 8px rgba(229,89,52,0.4);
}
.avatar.bot svg { width: 18px; height: 18px; }
.avatar.user-av {
  background: var(--border);
}
.avatar.user-av svg { width: 16px; height: 16px; }

.msg-body { display: flex; flex-direction: column; max-width: 76%; }
.msg.user .msg-body { align-items: flex-end; }

.bubble {
  padding: 13px 18px;
  line-height: 1.7;
  font-size: 13.5px;
  font-weight: 400;
}
.msg.bot .bubble {
  background: var(--white);
  color: var(--ink);
  border-radius: 3px var(--radius) var(--radius) var(--radius);
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border);
}
.msg.user .bubble {
  background: var(--ink);
  color: rgba(255,255,255,0.88);
  border-radius: var(--radius) 3px var(--radius) var(--radius);
  box-shadow: var(--shadow-md);
}
.msg-time {
  font-size: 10px; font-weight: 400;
  color: var(--slate-light);
  margin-top: 4px; padding: 0 3px;
}
.msg.user .msg-time { text-align: right; }

/* ‚îÄ‚îÄ TYPING ‚îÄ‚îÄ */
.typing-row { display: flex; gap: 11px; margin-bottom: 14px; animation: msgIn 0.28s ease both; }
.typing-bubble {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 3px var(--radius) var(--radius) var(--radius);
  padding: 15px 20px;
  display: flex; align-items: center; gap: 5px;
  box-shadow: var(--shadow-sm);
}
.typing-bubble span {
  width: 6px; height: 6px; border-radius: 50%;
  animation: tBounce 1.3s infinite;
}
.typing-bubble span:nth-child(1) { background: var(--slate-light); }
.typing-bubble span:nth-child(2) { background: var(--orange-deep); animation-delay: 0.18s; }
.typing-bubble span:nth-child(3) { background: var(--orange); animation-delay: 0.36s; }
@keyframes tBounce {
  0%,70%,100% { transform: translateY(0); opacity: 0.6; }
  35% { transform: translateY(-6px); opacity: 1; }
}

/* ‚îÄ‚îÄ CHOICES ‚îÄ‚îÄ */
.choices {
  display: flex; flex-wrap: wrap; gap: 8px;
  margin-bottom: 18px; padding-left: 45px;
  animation: msgIn 0.32s 0.08s ease both;
  opacity: 0; animation-fill-mode: forwards;
}
.choice-btn {
  padding: 9px 20px;
  border-radius: 100px;
  font-family: 'Sora', sans-serif;
  font-size: 12.5px; font-weight: 500;
  cursor: pointer;
  transition: all 0.16s ease;
  border: 1.5px solid var(--border-strong);
  background: var(--white);
  color: var(--ink);
  box-shadow: var(--shadow-sm);
  letter-spacing: 0.01em;
}
.choice-btn:hover {
  border-color: var(--orange);
  color: var(--orange);
  box-shadow: 0 3px 14px rgba(229,89,52,0.18);
  transform: translateY(-1px);
}
.choice-btn.primary {
  background: var(--orange);
  border-color: var(--orange);
  color: white;
  box-shadow: 0 4px 14px rgba(229,89,52,0.35);
}
.choice-btn.primary:hover {
  background: var(--orange-deep);
  border-color: var(--orange-deep);
  transform: translateY(-1px);
  box-shadow: 0 6px 20px rgba(229,89,52,0.4);
}

/* ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ */
.input-wrap {
  padding: 14px 0 26px;
  border-top: 1px solid var(--border);
  animation: msgIn 0.28s ease both;
}
.input-row {
  display: flex; gap: 10px; align-items: flex-end;
  background: var(--white);
  border: 1.5px solid var(--border-strong);
  border-radius: var(--radius);
  padding: 8px 8px 8px 18px;
  box-shadow: var(--shadow-sm);
  transition: border-color 0.2s, box-shadow 0.2s;
}
.input-row:focus-within {
  border-color: var(--orange);
  box-shadow: 0 0 0 3px rgba(229,89,52,0.1);
}
.text-input {
  flex: 1; border: none; outline: none; background: transparent;
  font-family: 'Sora', sans-serif;
  font-size: 13.5px; color: var(--ink);
  resize: none; min-height: 24px; max-height: 100px;
  line-height: 1.5; padding: 4px 0;
}
.text-input::placeholder { color: var(--slate-light); }
.send-btn {
  width: 40px; height: 40px; border-radius: var(--radius-sm);
  background: var(--orange); border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; transition: all 0.16s;
  box-shadow: 0 2px 8px rgba(229,89,52,0.3);
}
.send-btn:hover { background: var(--orange-deep); transform: scale(1.05); }
.send-btn svg { width: 17px; height: 17px; stroke: white; fill: none; stroke-width: 2.2; stroke-linecap: round; stroke-linejoin: round; }

/* ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ */
.upload-wrap { padding-left: 45px; margin-bottom: 14px; }
.upload-zone {
  border: 2px dashed var(--border-strong);
  border-radius: var(--radius);
  padding: 30px 24px; text-align: center;
  cursor: pointer; background: var(--white);
  transition: all 0.2s; box-shadow: var(--shadow-sm);
  animation: msgIn 0.32s ease both;
}
.upload-zone:hover, .upload-zone.drag-over {
  border-color: var(--orange);
  background: #fff8f6;
  box-shadow: 0 4px 20px rgba(229,89,52,0.12);
}
.upload-icon-wrap {
  width: 50px; height: 50px; border-radius: 14px;
  background: rgba(229,89,52,0.1);
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto 14px;
}
.upload-icon-wrap svg { width: 24px; height: 24px; stroke: var(--orange); fill: none; stroke-width: 2; stroke-linecap: round; }
.upload-title { font-size: 13.5px; font-weight: 600; color: var(--ink); margin-bottom: 5px; }
.upload-sub { font-size: 11.5px; color: var(--slate); line-height: 1.7; }
.upload-sub span { color: var(--orange); font-weight: 500; }
input[type="file"] { display: none; }

/* ‚îÄ‚îÄ SKILLS ‚îÄ‚îÄ */
.skills-list { display: flex; flex-wrap: wrap; gap: 7px; margin-top: 12px; }
.skill-tag {
  padding: 5px 13px;
  background: rgba(229,89,52,0.08);
  border: 1px solid rgba(229,89,52,0.2);
  border-radius: 100px;
  font-size: 11.5px; color: var(--orange-deep); font-weight: 500;
}

/* ‚îÄ‚îÄ DONE CARD ‚îÄ‚îÄ */
.done-card {
  margin: 10px 0 10px 45px;
  background: var(--white);
  border: 1px solid var(--border);
  border-top: 3px solid var(--orange);
  border-radius: var(--radius);
  padding: 28px 28px 26px;
  text-align: center;
  box-shadow: var(--shadow-md);
  animation: msgIn 0.5s ease both;
}
.done-check {
  width: 52px; height: 52px; border-radius: 50%;
  background: rgba(229,89,52,0.1);
  border: 2px solid rgba(229,89,52,0.3);
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto 16px;
}
.done-check svg { width: 24px; height: 24px; stroke: var(--orange); fill: none; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; }
.done-title {
  font-family: 'Playfair Display', serif;
  font-size: 21px; font-style: italic;
  color: var(--ink); margin-bottom: 8px;
}
.done-sub { font-size: 12px; color: var(--slate); line-height: 2; }

/* ‚îÄ‚îÄ BLOCKED CARD ‚îÄ‚îÄ */
.blocked-card {
  margin: 10px 0 10px 45px;
  background: #fff8f6;
  border: 1px solid rgba(229,89,52,0.2);
  border-radius: var(--radius);
  padding: 22px 24px;
  text-align: center;
  box-shadow: var(--shadow-sm);
  animation: msgIn 0.4s ease both;
}
.blocked-icon { font-size: 28px; margin-bottom: 10px; }
.blocked-title { font-size: 13.5px; font-weight: 600; color: var(--ink); margin-bottom: 6px; }
.blocked-sub { font-size: 12px; color: var(--slate); line-height: 1.8; }

.highlight { color: var(--orange); font-family: 'Playfair Display', serif; font-style: italic; font-size: 1.06em; }
.hp-field { display: none; }

::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 4px; }

@media (max-width: 600px) {
  header { padding: 0 14px; }
  main { padding: 0 10px; }
  .choices { padding-left: 40px; }
  .upload-wrap { padding-left: 40px; }
  .done-card, .blocked-card { margin-left: 40px; }
  .bubble { font-size: 13px; padding: 12px 15px; }
}
</style>
</head>
<body>

<div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>

<header>
  <div class="header-left">
    <!-- ATRIOS Logo Mark: orange triangle with white arrow -->
    <svg class="logo-mark" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
      <polygon points="18,2 34,32 2,32" fill="#E55934"/>
      <!-- upward arrow inside triangle -->
      <polygon points="18,8 24,20 21,20 21,28 15,28 15,20 12,20" fill="white"/>
    </svg>
    <div class="header-brand">
      <div class="brand-name">ATR<span>I</span>OS</div>
      <div class="brand-sub">Leadership Talent Network</div>
    </div>
  </div>
  <div class="header-right">
    <div class="online-dot"></div>
    Live
  </div>
</header>

<main>
  <div class="chat-window" id="chatWindow">
    <div class="date-chip">Today</div>
  </div>
  <div id="inputArea"></div>
</main>

<input type="text" class="hp-field" id="hp_name" name="hp_name" autocomplete="off" tabindex="-1">

<script>
const chat = document.getElementById('chatWindow');
const inputArea = document.getElementById('inputArea');
const progressFill = document.getElementById('progressFill');
const RAILWAY_BASE = 'https://atrios-talent-intelligence-engine-production.up.railway.app';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const state = { email: '', name: '', skills: [] };

// ‚îÄ‚îÄ SECURITY: interaction tracking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let userInteracted = false;
let pageLoadTime = Date.now();
document.addEventListener('mousemove', () => userInteracted = true, { once: true });
document.addEventListener('touchstart', () => userInteracted = true, { once: true });
document.addEventListener('keydown', () => userInteracted = true, { once: true });

// ‚îÄ‚îÄ SECURITY: rate limit (5 uploads per device per day) ‚îÄ‚îÄ‚îÄ
const RATE_KEY = 'atrios_uploads';
const RATE_LIMIT = 5;

function getRateData() {
  try {
    const raw = localStorage.getItem(RATE_KEY);
    if (!raw) return { count: 0, date: todayStr() };
    return JSON.parse(raw);
  } catch { return { count: 0, date: todayStr() }; }
}

function todayStr() {
  return new Date().toISOString().slice(0, 10);
}

function isRateLimited() {
  const data = getRateData();
  if (data.date !== todayStr()) return false; // new day, reset
  return data.count >= RATE_LIMIT;
}

function incrementRate() {
  const data = getRateData();
  const today = todayStr();
  const count = data.date === today ? data.count + 1 : 1;
  localStorage.setItem(RATE_KEY, JSON.stringify({ count, date: today }));
}

// ‚îÄ‚îÄ SECURITY: file hash (prevent same file re-upload today) ‚îÄ‚îÄ
async function hashFile(file) {
  const buf = await file.arrayBuffer();
  const digest = await crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function isHashSeen(hash) {
  try {
    const raw = localStorage.getItem('atrios_hashes');
    const data = raw ? JSON.parse(raw) : {};
    const today = todayStr();
    return data[today]?.includes(hash);
  } catch { return false; }
}

function recordHash(hash) {
  try {
    const raw = localStorage.getItem('atrios_hashes');
    const data = raw ? JSON.parse(raw) : {};
    const today = todayStr();
    // Only keep today's hashes
    const todayHashes = data[today] || [];
    todayHashes.push(hash);
    localStorage.setItem('atrios_hashes', JSON.stringify({ [today]: todayHashes }));
  } catch {}
}

// ‚îÄ‚îÄ SECURITY: MX record check via DNS-over-HTTPS ‚îÄ‚îÄ
async function hasMXRecord(domain) {
  try {
    const res = await fetch(`https://dns.google/resolve?name=${domain}&type=MX`, { signal: AbortSignal.timeout(3000) });
    const data = await res.json();
    return !!(data.Answer && data.Answer.length > 0);
  } catch { return true; } // fail open ‚Äî don't block if DNS check fails
}

// ‚îÄ‚îÄ AVATARS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BOT_AV = `<div class="avatar bot">
  <svg viewBox="0 0 36 36" fill="none">
    <polygon points="18,3 33,30 3,30" fill="white" opacity="0.95"/>
    <polygon points="18,9 23,19 20.5,19 20.5,26 15.5,26 15.5,19 13,19" fill="#E55934"/>
  </svg>
</div>`;

const USER_AV = `<div class="avatar user-av">
  <svg viewBox="0 0 24 24" fill="none">
    <circle cx="12" cy="8.5" r="3.8" stroke="#9ca3af" stroke-width="1.8"/>
    <path d="M4 20c0-3.8 3.6-6.8 8-6.8s8 3 8 6.8" stroke="#9ca3af" stroke-width="1.8" stroke-linecap="round"/>
  </svg>
</div>`;

// ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function uploadCV(file) {
  const fd = new FormData();
  fd.append('file', file);
  fd.append('email', state.email);
  const res = await fetch(`${RAILWAY_BASE}/api/v1/candidates/upload`, { method: 'POST', body: fd });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
function setProgress(p) { progressFill.style.width = p + '%'; }
function scrollBottom() { setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 60); }
function clearInput() { inputArea.innerHTML = ''; }
function nowTime() { return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }

function addMsg(role, html) {
  return new Promise(resolve => {
    const msg = document.createElement('div');
    msg.className = `msg ${role}`;
    const body = document.createElement('div');
    body.className = 'msg-body';
    body.innerHTML = `<div class="bubble">${html}</div><div class="msg-time">${nowTime()}</div>`;
    msg.innerHTML = role === 'bot' ? BOT_AV : USER_AV;
    msg.appendChild(body);
    chat.appendChild(msg);
    scrollBottom();
    resolve();
  });
}

function showTyping() {
  const row = document.createElement('div');
  row.className = 'typing-row'; row.id = 'typingRow';
  row.innerHTML = `${BOT_AV}<div class="typing-bubble"><span></span><span></span><span></span></div>`;
  chat.appendChild(row); scrollBottom();
}
function removeTyping() { const el = document.getElementById('typingRow'); if (el) el.remove(); }

function showChoices(options, onSelect) {
  const div = document.createElement('div');
  div.className = 'choices';
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = `choice-btn ${opt.primary ? 'primary' : ''}`;
    btn.textContent = opt.label;
    btn.onclick = () => { div.remove(); addMsg('user', opt.label); onSelect(opt.value); };
    div.appendChild(btn);
  });
  inputArea.appendChild(div); scrollBottom();
}

function showTextInput(placeholder, onSubmit) {
  clearInput();
  const wrap = document.createElement('div');
  wrap.className = 'input-wrap';
  wrap.innerHTML = `
    <div class="input-row">
      <textarea class="text-input" placeholder="${placeholder}" rows="1" id="mainInput"></textarea>
      <button class="send-btn" id="sendBtn">
        <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>`;
  inputArea.appendChild(wrap);
  const inp = document.getElementById('mainInput');
  inp.focus();
  inp.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); submit(); } });
  inp.addEventListener('input', () => { inp.style.height = 'auto'; inp.style.height = inp.scrollHeight + 'px'; });
  document.getElementById('sendBtn').onclick = submit;
  function submit() {
    const val = inp.value.trim();
    if (!val || document.getElementById('hp_name').value) return;
    clearInput(); addMsg('user', val); onSubmit(val);
  }
}

function showUpload(onFile) {
  clearInput();
  const wrap = document.createElement('div');
  wrap.className = 'upload-wrap';
  wrap.innerHTML = `
    <div class="upload-zone" id="uploadZone">
      <div class="upload-icon-wrap">
        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      </div>
      <div class="upload-title">Upload your CV</div>
      <div class="upload-sub"><span>Click to browse</span> or drag & drop<br>PDF or DOCX ¬∑ Max 10MB</div>
      <input type="file" id="fileInput" accept=".pdf,.docx">
    </div>`;
  inputArea.appendChild(wrap);

  const zone = document.getElementById('uploadZone');
  const fi = document.getElementById('fileInput');
  zone.onclick = () => fi.click();
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
  zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('drag-over'); handleFile(e.dataTransfer.files[0]); });
  fi.onchange = () => handleFile(fi.files[0]);

  async function handleFile(file) {
    if (!file) return;

    // File type check
    const ok = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    if (!ok.includes(file.type) && !file.name.match(/\.(pdf|docx)$/i)) {
      await addMsg('bot', 'Please upload a PDF or DOCX file only.');
      return showUpload(onFile);
    }

    // File size check
    if (file.size > 10 * 1024 * 1024) {
      await addMsg('bot', 'That file is too large. Please upload something under 10MB.');
      return showUpload(onFile);
    }

    // SECURITY: bot timing check ‚Äî less than 8 seconds on page = bot
    if (!userInteracted || (Date.now() - pageLoadTime) < 8000) {
      clearInput(); return;
    }

    // SECURITY: daily rate limit
    if (isRateLimited()) {
      clearInput();
      showBlocked();
      return;
    }

    // SECURITY: file hash dedup
    const hash = await hashFile(file);
    if (isHashSeen(hash)) {
      clearInput();
      await addMsg('bot', "It looks like you've already submitted today. We'll be in touch if your profile is a match.");
      return;
    }

    clearInput();
    addMsg('user', `üìé ${file.name}`);
    onFile(file, hash);
  }
}

function showBlocked() {
  const card = document.createElement('div');
  card.className = 'blocked-card';
  card.innerHTML = `
    <div class="blocked-icon">üïê</div>
    <div class="blocked-title">See you tomorrow</div>
    <div class="blocked-sub">It looks like you've already submitted today.<br>We'll be in touch if your profile is a match.</div>`;
  inputArea.appendChild(card);
  scrollBottom();
}

// ‚îÄ‚îÄ FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function step0_welcome() {
  setProgress(10);
  await addMsg('bot', `Hello! I'm the <span class="highlight">ATRIOS</span> Assistant. üëã<br>I'm here to help you join our Leadership Talent Network. Shall we begin?`);
  await delay(200);
  showChoices([
    { label: "Yes, let's begin", value: 'yes', primary: true },
    { label: 'Not right now', value: 'no' }
  ], val => val === 'yes' ? step1_email() : stepExit());
}

function stepExit() {
  clearInput();
  addMsg('bot', "No problem ‚Äî feel free to return whenever you're ready. üåø");
}

async function step1_email() {
  setProgress(22);
  await addMsg('bot', "Let's start with your email address.");
  askEmail();
}

function askEmail() {
  showTextInput('Enter your email address', async email => {
    // Basic format check
    if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
      await addMsg('bot', "That doesn't look right ‚Äî could you double-check your email?");
      return askEmail();
    }

    // Disposable email block
    const disposable = ['mailinator.com','tempmail.com','guerrillamail.com','10minutemail.com','throwaway.email','yopmail.com','trashmail.com'];
    const domain = email.split('@')[1].toLowerCase();
    if (disposable.includes(domain)) {
      await addMsg('bot', "Please use a professional email ‚Äî temporary domains aren't accepted.");
      return askEmail();
    }

    // SECURITY: MX record check
    clearInput();
    showTyping();
    const hasMX = await hasMXRecord(domain);
    removeTyping();
    if (!hasMX) {
      await addMsg('bot', `I couldn't verify <strong>${domain}</strong>. Please check your email address and try again.`);
      return askEmail();
    }

    state.email = email;
    step2_upload();
  });
}

async function step2_upload() {
  setProgress(45);
  await addMsg('bot', "Great! Please upload your CV or LinkedIn profile export.");
  showUpload((file, hash) => step3_parseCV(file, hash));
}

async function step3_parseCV(file, hash) {
  setProgress(65);
  clearInput();
  await addMsg('bot', "Thanks! Reading through your profile now‚Ä¶");
  showTyping();
  try {
    const parsed = await uploadCV(file);
    removeTyping();

    // Record hash and increment rate counter on success
    recordHash(hash);
    incrementRate();

    state.name = parsed.name || parsed.candidate?.name || '';
    state.skills = parsed.skills || parsed.candidate?.skills || [];
    step4_skills();
  } catch (e) {
    removeTyping();
    await addMsg('bot', "There was a problem processing that file. Please try uploading again.");
    showUpload((f, h) => step3_parseCV(f, h));
  }
}

async function step4_skills() {
  setProgress(90);
  if (state.skills?.length > 0) {
    await addMsg('bot', `Thank you, <span class="highlight">${state.name}</span>!<br>Here are the key skills I found in your profile:<div class="skills-list">${state.skills.map(s => `<span class="skill-tag">${s}</span>`).join('')}</div>`);
  } else {
    await addMsg('bot', `Thank you, <span class="highlight">${state.name || 'for sharing your profile'}</span>! Your details have been captured.`);
  }
  await delay(600);
  step5_close();
}

async function step5_close() {
  setProgress(100);
  clearInput();
  await addMsg('bot', `That's everything from my side, <span class="highlight">${state.name || 'there'}</span>.<br>You're now officially part of the <strong>ATRIOS Leadership Talent Network</strong>.<br>Our team will reach out when a relevant mandate comes up. ‚ú¶`);
  await delay(500);
  const done = document.createElement('div');
  done.className = 'done-card';
  done.innerHTML = `
    <div class="done-check"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
    <div class="done-title">You're in the Network</div>
    <div class="done-sub">We'll be in touch when the right mandate arises.<br>Leadership is patient. So are we.</div>`;
  chat.appendChild(done);
  scrollBottom();
}

setTimeout(() => step0_welcome(), 500);
</script>
</body>
</html>
